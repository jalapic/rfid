---
title: "mia-rfid"
output:
  html_document: default
  pdf_document: default
---

loading in packages
```{r, warning=FALSE, message=FALSE, results='hide'}
library(tidyverse)

```

loading in data
```{r, warning=FALSE, message=FALSE, results='hide'}
df1 <- read_csv2("raw_data/Tracking/rawdata20210604.csv")
df2 <- read_csv2("raw_data/Tracking/rawdata20210605.csv")
df3 <- read_csv2("raw_data/Tracking/rawdata20210606.csv")
df4 <- read_csv2("raw_data/Tracking/rawdata20210607.csv")
df5 <- read_csv2("raw_data/Tracking/rawdata20210608.csv")
df6 <- read_csv2("raw_data/Tracking/rawdata20210609.csv")
df7 <- read_csv2("raw_data/Tracking/rawdata20210610.csv")
```

stacking the data together
```{r, warning=FALSE, message=FALSE, results='hide'}
df <- rbind(df1, df2, df3, df4, df5, df6, df7)

df$data <- as.character(df$data)

df
```

creating milliseconds (ms) column
```{r, warning=FALSE, message=FALSE, results='hide'}
df$date <- format(as.POSIXct(df$datetimestamp,format="%d.%m.%Y %H:%M:%S:%OS"),"%m.%d.%Y")
  
df$time <- sub("^\\S+\\s+", '', df$datetimestamp)

xx <- strsplit(df$time, split=":")

#xx
xxx <- matrix(unlist(xx), ncol = 4, byrow = TRUE)
#xxx[,1]
#xxx[,2]
#xxx[,3]
#as.numeric(xxx[,4])

df$ms<-
  (3600000 * as.numeric(xxx[,1])) +
(60000 * as.numeric(xxx[,2])) +
(1000 * as.numeric(xxx[,3])) +
(1 * as.numeric(xxx[,4]))
```

editing ms column to account for number days past
```{r, warning=FALSE, message=FALSE, results='hide'}
day_1 <- df %>% filter(date == "06.04.2021")

  day_1$ms <- as.numeric(unlist(day_1$ms)) - 40089792

day_2 <- df %>% filter(date == "06.05.2021")

  day_2$ms <- (as.numeric(unlist(day_2$ms)) + (8.64e+7 * 1)) - 40089792

day_3 <- df %>% filter(date == "06.06.2021")

  day_3$ms <- (as.numeric(unlist(day_3$ms)) + (8.64e+7 * 2)) - 40089792

day_4 <- df %>% filter(date == "06.07.2021")

  day_4$ms <- (as.numeric(unlist(day_4$ms)) + (8.64e+7 * 3)) - 40089792

day_5 <- df %>% filter(date == "06.08.2021")

  day_5$ms <- (as.numeric(unlist(day_5$ms)) + (8.64e+7 * 4)) - 40089792
  
day_6 <- df %>% filter(date == "06.09.2021")

  day_6$ms <- (as.numeric(unlist(day_6$ms)) + (8.64e+7 * 5)) - 40089792

day_7 <- df %>% filter(date == "06.10.2021")

  day_7$ms <- (as.numeric(unlist(day_7$ms)) + (8.64e+7 * 6)) - 40089792

df <- rbind(day_1, day_2, day_3, day_4, day_5, day_6, day_7)

df$ms <- as.character(df$ms)

as.data.frame(df[37200:37300, ])
```

comparing `cantimestamp` with `milliseconds`
```{r}
plot(df$cantimestamp, type = "l")
plot(df$ms, type = "l")

```
```{r}
head(df)
df %>% 
  group_by(date) %>%
  arrange(ms) %>%
  mutate(rowid=row_number()) %>%
  ggplot(., aes(x=rowid, y=cantimestamp)) +
  geom_line() +
  facet_wrap(~date)
```

comparing cantimestamp restarting points to ms
```{r}
which(lead(df$cantimestamp)<df$cantimestamp) + 1 

drops <- df$ms[which(lead(df$cantimestamp)<df$cantimestamp) + 1 ]

drops <- as.data.frame(as.numeric(drops))
colnames(drops) <- c("delta_drops")

drops <- tail(drops, -1) - head(drops, -1)

table(drops)

hist(drops$delta_drops)

hist(df$cantimestamp)
```

for Fri 7/9 meeting
----

organizing
```{r}
a1 <- df[,c(6,7,8,5,3,4)]

a2 <- a1[!is.na(a1$data),]

head(a2)
```


subsetting data by mouse
```{r}
dfx<-data.frame(data=c("900133000459724", "900133000459725",
                   "900133000459723","900133000459727",
                   "900133000459722", "900133000459721",
                   "900133000459719", "900133000459693"),
            mouse = c(4,4,3,3,2,2,1,1)
            )
 getwd()
 write.csv(dfx,"raw_data/mouseids.csv", row.names = F)

dfx <- read_csv("raw_data/mouseids.csv")
dfx

## Extract individual dataframes for each animal.

mouse1 <- subset(a2, data %in% dfx[dfx$mouse==1,]$data) %>% mutate(mouse = 1)
mouse2 <- subset(a2, data %in% dfx[dfx$mouse==2,]$data) %>% mutate(mouse = 2)
mouse3 <- subset(a2, data %in% dfx[dfx$mouse==3,]$data) %>% mutate(mouse = 3)
mouse4 <- subset(a2, data %in% dfx[dfx$mouse==4,]$data) %>% mutate(mouse = 4)
```


making a function to report impossible tube connections
```{r, warning=FALSE, message=FALSE, results='hide'}
tube_errors <- function(df, pair1=c(1,2), pair2=c(3,4)){
  
  ids <- c(pair1,pair2)
  codes <- c("3","19", "17", "9")
  
  x <- codes[match(df$deviceid, ids)]
  
  row.inds <-
    c(intersect(which(x == "3"),which(lead(x) == "19" | lag(x) == "19")),
      intersect(which(x == "17"),which(lead(x) == "9" | lag(x) == "9"))
      )
  
  df$error <- FALSE
  df[row.inds,"error"]<-TRUE

  
  return(df)
  }

mouse1 <- as.data.frame(tube_errors(mouse1, pair1 = c(3,19), pair2 = c(17,9)))

filter(mouse1, error==TRUE)
 
mouse2 <- as.data.frame(tube_errors(mouse2, pair1 = c(3,19), pair2 = c(17,9)))

filter(mouse2, error==TRUE)

mouse3 <- as.data.frame(tube_errors(mouse3, pair1 = c(3,19), pair2 = c(17,9)))

filter(mouse3, error==TRUE)

mouse4 <- as.data.frame(tube_errors(mouse4, pair1 = c(3,19), pair2 = c(17,9)))

filter(mouse4, error==TRUE)

## look at tube errors - how long are locations unknown for?
```


figuring out how much time a mouse spends in each tube
```{r}
m1 <- mouse1[1:65,]

m1_1 <- rle(m1$deviceid)

m1_1$values

## how much time in each tube (value) ??
```

```{r}
##look at rev

m1_2 <- rle(m1$deviceid)
m1_3 <- cumsum(c(1, m1_2$lengths[-length(m1_2$lengths -1)]))

m1_4 <- m1[m1_3,]

str(m1_4)

m1_4$ms <- as.numeric(m1_4$ms)

m1_4$length <- -m1_4$ms + lead(m1_4$ms)

head(m1_4)

# so, mouse 1 spent 18488ms in tube 3 and cage 2, 15018597ms in tube 9 and cage 2, etc
```

figuring out how to separate time spent in tube versus cage
```{r}

```










